# -*- coding: utf-8 -*-

"""
 (c) 2023 - Copyright CTyunOS Inc

 Authors:
   youyifeng <youyf2@chinatelecom.cn>

"""
import requests
import json


class Dingding():
    """
    钉钉聊天机器人
    """

    def __init__(self, gconfig, keyname='status_key'):
        self._config = gconfig

        self._key = None
        for (name, value) in gconfig.config['dingding'].items():
            if name == keyname:
                self._key = value

    def do_send(self, data):
        res = None
        headers = {'Content-Type': 'application/json'}
        url = f'https://oapi.dingtalk.com/robot/send?access_token={self._key}'
        r = requests.post(url=url, headers=headers, data=json.dumps(data))
        try:
            res = json.loads(r.text)
        except:
            pass
        if r.status_code == 200 and res and 'errcode' in res and 0 == res['errcode']:
            print('[+] dingdingBot 发送成功')
        else:
            print('[-] dingdingBot 发送失败')
            print(r.text)

    def send_text(self, msg="", debug=False):
        data = {
            "msgtype": "text",
            "text": {
                "content": 'cve-ease notifier: \n' + msg,
            },
        }
        if debug:
            print(json.dumps(data, indent=4))
        self.do_send(data)
