# -*- coding: utf-8 -*-

"""
 (c) 2023 - Copyright CTyunOS Inc

 Authors:
   youyifeng <youyf2@chinatelecom.cn>

"""
import requests
import json
from cve_ease_dev.helper import get_timestamp

from .base import NotifierBase


class Feishu(NotifierBase):
    """
    feishu bot
    """

    def __init__(self, gconfig, keyname='status_key'):
        self._config = gconfig

        self._key = None
        for (name, value) in gconfig.config['feishu'].items():
            if name == keyname:
                self._key = value

    def do_send(self, data):
        res = None
        headers = {'Content-Type': 'application/json; charset=utf-8'}
        url = f'https://open.feishu.cn/open-apis/bot/v2/hook/{self._key}'
        r = requests.post(url=url, headers=headers, data=json.dumps(data))
        try:
            res = json.loads(r.text)
        except:
            pass
        if r.status_code == 200 and res and 'StatusCode' in res and 0 == res['StatusCode']:
            print('[+] feishuBot send ok!')
        else:
            print('[-] feishuBot send failed!')
            print(r.text)

    def send_text(self, msg="", debug=False):
        data = {
            "msg_type": "text",
            "content": {
                "text": 'cve-ease notifier: \n%s\n%s' % (get_timestamp(), msg),
            },
        }
        if debug:
            print(json.dumps(data, indent=4))
        self.do_send(data)


    def do_cve_notifier(self, diff):
        print("do_cve_notifier")

    def do_sa_notifier(self, diff):
        print("do_sa_notifier")
