# -*- coding: utf-8 -*-

"""
 (c) 2023 - Copyright CTyunOS Inc

 Authors:
   youyifeng <youyf2@chinatelecom.cn>

"""
import os
from optparse import OptionParser
from cve_ease_dev import activate_session, Scraper
import logging
from cve_ease_dev.helper import one_instance_check, parseRPM
from cve_ease_dev.models import Repos, Repo, Package, RPM
from sqlalchemy.sql import text

logger = logging.getLogger('cve-ease')


def get_usage_str(usage):
    return usage + "\n(Specify the --help global option for a list of other help options)"


openeuler_product_map = [
    "https://mirrors.tuna.tsinghua.edu.cn/openeuler/openEuler-20.03-LTS-SP1/everything/x86_64/",
    # "https://mirrors.tuna.tsinghua.edu.cn/openeuler/openEuler-20.03-LTS-SP1/update/x86_64/",
]


def parser_repo():
    repos = Repos()
    for repo in openeuler_product_map:
        print("makecache %s" % repo)
        repos.addrepo(repo)
    return repos


def handle_repodata(gconfig, db_session, args):
    """[info] Repodata info"""
    # one instance
    lock = one_instance_check(gconfig.LOCK_FILE_PATH)
    if lock:
        raise Exception(f"Another cve-ease already running")

    usage = "usage: %prog repodata <options>"
    parser = OptionParser(usage=get_usage_str(usage))

    parser.add_option('-m', '--makecache', dest='makecache', action='store_true', default=False,
                      help='Cache repodata to database')
    parser.add_option('-t', '--total', dest='total', action='store_true', default=False,
                      help='Get total rpm statistic')
    parser.add_option('-l', '--list', dest='list', action='store_true', default=False,
                      help='List all rpm')
    parser.add_option('-c', '--check', dest='check', action='store_true', default=False,
                      help='Check repo cve')
    parser.add_option('-v', '--verbose', dest='verbose', action='store_true', default=False,
                      help='Show verbose output')

    (options, args) = parser.parse_args(args)

    session = activate_session(db_session, gconfig)
    if gconfig.debug:
        print("active sql session")

    if options.makecache:
        repos = parser_repo()
        allpkglist = repos.list()
        for index, (url, pkg) in enumerate(allpkglist):
            rpm = RPM()

            rpm.sourcerpm = pkg.sourcerpm
            rpm.sname, rpm.sver, rpm.srel, rpm.sepoch, rpm.sarch = parseRPM(rpm.sourcerpm)

            rpm.rpmname = pkg.rpmname
            rpm.name, rpm.ver, rpm.rel, rpm.epoch, rpm.arch = parseRPM(rpm.rpmname)

            rpm.location = pkg.location
            rpm.downloadurl = os.path.join(url, pkg.location)

            session.add(rpm)
            session.commit()
            print("[%6d/%-6d] Cache OK! %s" % (index + 1, len(allpkglist) - index - 1, pkg.rpmname))
        try:
            session.execute(
                text(
                    "INSERT INTO SRPM (sourcerpm, sname, sver, srel, sepoch, sarch) SELECT DISTINCT sourcerpm, sname, sver, srel, sepoch, sarch FROM RPM;"
                )
            )
            session.commit()
        except Exception as e:
            print(" * create SRPM table failed!", str(e))
        print(" * cache SRPM table done!")
    elif options.list:
        rpmlist = session.query(RPM).all()
        if 0 == len(rpmlist):
            print(" WARNNING: no rpm cache found! you should run 'cve-ease repodata -m' to cache it.")
            return
        for pkg in rpmlist:
            print(pkg.rpmname, pkg.sourcerpm, pkg.sname)
            print(pkg.downloadurl)
    elif options.total:
        total = session.query(RPM).count()
        print("rpm total record :", total)
        if 0 == total:
            print(" WARNNING: no rpm cache found! you should run 'cve-ease repodata -m' to cache it.")
    elif options.check:
        repos = parser_repo()
        res = repos.list()
        for url, pkg in res:
            print(url, pkg.rpmname, pkg.sourcerpm, pkg.sname)
        print("check done!")
    else:
        parser.print_help()
