# -*- coding: utf-8 -*-

"""
 (c) 2023 - Copyright CTyunOS Inc

 Authors:
   youyifeng <youyf2@chinatelecom.cn>

"""

from optparse import OptionParser
from cve_ease_dev import activate_session, Scraper
from sqlalchemy import select
from cve_ease_dev.models import CVE
import logging

logger = logging.getLogger('cve-ease')


def get_usage_str(usage):
    return usage + "\n(Specify the --help global option for a list of other help options)"


def handle_cve(gconfig, session, args):
    usage = "usage: %prog cve <options>"
    parser = OptionParser(usage=get_usage_str(usage))

    parser.add_option('-m', '--makecache', dest='makecache', action='store_true', default=False,
                      help='get cve cache')
    parser.add_option('-l', '--list', dest='list', action='store_true', default=False,
                      help='list all cve info')
    parser.add_option('-t', '--total', dest='total', action='store_true', default=False,
                      help='get total cve record number')

    (options, args) = parser.parse_args(args)

    session = activate_session(session, gconfig)
    if gconfig.debug:
        print("active sql session")

    if options.makecache:
        scraper = Scraper()
        response = scraper.scrapyCVE()
        if "code" in response and response["code"] == 0:
            print(" * scrapy from OpenEuler done")
            totalCount = response["result"]["totalCount"]
            print(" * total record num:", totalCount)
            cveDatabaseList = response["result"]["cveDatabaseList"]
            session.bulk_insert_mappings(CVE, cveDatabaseList)
            session.commit()
            session.close()
            print(" * makecache done")
        else:
            print("response error! no usefull info found!")
    elif options.total:
        print("total", session.query(CVE).count())
    elif options.list:
        print("list")
        # TODO


"""

{"id":22370,"affectedProduct":"","announcementTime":"","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-26081","cvsssCoreNVD":"7.5","cvsssCoreOE":"7.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"epiphany","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Unaffected","summary":"In Epiphany (aka GNOME Web) through 43.0, untrusted web content can trick users into exfiltrating passwords, because autofill occurs in sandboxed contexts.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-03 11:01:01","createTime":"2023-03-03 11:01:01","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null}



{"code":0,"msg":"","result":{"totalCount":5329,"securityNoticeList":[],"cveDatabaseList":[{"id":22370,"affectedProduct":"","announcementTime":"","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-26081","cvsssCoreNVD":"7.5","cvsssCoreOE":"7.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"epiphany","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Unaffected","summary":"In Epiphany (aka GNOME Web) through 43.0, untrusted web content can trick users into exfiltrating passwords, because autofill occurs in sandboxed contexts.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-03 11:01:01","createTime":"2023-03-03 11:01:01","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22369,"affectedProduct":"","announcementTime":"","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-0240","cvsssCoreNVD":"7.8","cvsssCoreOE":"7.8","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"kernel","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Unaffected","summary":"There is a logic error in io_uring s implementation which can be used to trigger a use-after-free vulnerability leading to privilege escalation. In the io_prep_async_work function the assumption that the last io_grab_identity call cannot return false is not true, and in this case the function will use the init_cred or the previous linked requests identity to do operations instead of using the current identity. This can lead to reference counting issues causing use-after-free. We recommend upgrading past version 5.10.161.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-02 11:00:52","createTime":"2023-03-02 11:00:52","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22364,"affectedProduct":"","announcementTime":"2023-03-01","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-22794","cvsssCoreNVD":"8.8","cvsssCoreOE":"8.8","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"rubygem-activerecord","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"A vulnerability in ActiveRecord \u003c6.0.6.1, v6.1.7.1 and v7.0.4.1 related to the sanitization of comments. If malicious user input is passed to either the `annotate` query method, the `optimizer_hints` query method, or through the QueryLogs interface which automatically adds annotations, it may be sent to the database withinsufficient sanitization and be able to inject SQL outside of the comment.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 19:38:25","createTime":"2023-03-01 11:01:28","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22365,"affectedProduct":"","announcementTime":"2023-03-01","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2022-44566","cvsssCoreNVD":"7.5","cvsssCoreOE":"7.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"rubygem-activerecord","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"A denial of service vulnerability present in ActiveRecord s PostgreSQL adapter \u003c7.0.4.1 and \u003c6.1.7.1. When a value outside the range for a 64bit signed integer is provided to the PostgreSQL connection adapter, it will treat the target column type as numeric. Comparing integer values against numeric values can result in a slow sequential scan resulting in potential Denial of Service.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 19:38:25","createTime":"2023-03-01 11:01:28","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22368,"affectedProduct":"","announcementTime":"2023-03-01","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-0687","cvsssCoreNVD":"9.8","cvsssCoreOE":"9.8","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"glibc","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"** DISPUTED ** A vulnerability was found in GNU C Library 2.38. It has been declared as critical. This vulnerability affects the function __monstartup of the file gmon.c of the component Call Graph Monitor. The manipulation leads to buffer overflow. It is recommended to apply a patch to fix this issue. VDB-220246 is the identifier assigned to this vulnerability. NOTE: The real existence of this vulnerability is still doubted at the moment. The inputs that induce this vulnerability are basically addresses of the running application that is built with gmon enabled. It's basically trusted input or input that needs an actual security flaw to be compromised or controlled.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 19:38:01","createTime":"2023-03-01 19:38:01","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22290,"affectedProduct":"","announcementTime":"2023-02-24","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2022-3724","cvsssCoreNVD":"7.5","cvsssCoreOE":"7.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"wireshark","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"Crash in the USB HID protocol dissector in Wireshark 3.6.0 to 3.6.8 allows denial of service via packet injection or crafted capture file on Windows","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 11:01:28","createTime":"2023-02-17 18:50:02","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22291,"affectedProduct":"","announcementTime":"2023-02-24","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2022-4344","cvsssCoreNVD":"4.3","cvsssCoreOE":"4.3","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"wireshark","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"Memory exhaustion in the Kafka protocol dissector in Wireshark 4.0.0 to 4.0.1 and 3.6.0 to 3.6.9 allows denial of service via packet injection or crafted capture file","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 11:01:28","createTime":"2023-02-17 18:50:02","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22292,"affectedProduct":"","announcementTime":"2023-02-24","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2022-4345","cvsssCoreNVD":"6.5","cvsssCoreOE":"6.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"wireshark","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Fixed","summary":"Infinite loops in the BPv6, OpenFlow, and Kafka protocol dissectors in Wireshark 4.0.0 to 4.0.1 and 3.6.0 to 3.6.9 allows denial of service via packet injection or crafted capture file","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 11:01:28","createTime":"2023-02-17 18:50:02","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22344,"affectedProduct":"","announcementTime":"","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2023-0217","cvsssCoreNVD":"7.5","cvsssCoreOE":"7.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"edk2","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Unaffected","summary":"An invalid pointer dereference on read can be triggered when an application tries to check a malformed DSA public key by the EVP_PKEY_public_check() function. This will most likely lead to an application crash. This function can be called on public keys supplied from untrusted sources which could allow an attacker to cause a denial of service attack. The TLS implementation in OpenSSL does not call this function but applications might call the function if there are additional security requirements imposed by standards such as FIPS 140-3.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 11:01:28","createTime":"2023-02-27 11:01:12","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null},{"id":22352,"affectedProduct":"","announcementTime":"","attackComplexityNVD":"","attackComplexityOE":"","attackVectorNVD":"","attackVectorOE":"","availabilityNVD":"","availabilityOE":"","confidentialityNVD":"","confidentialityOE":"","cveId":"CVE-2022-3110","cvsssCoreNVD":"5.5","cvsssCoreOE":"5.5","integrityNVD":"","integrityOE":"","nationalCyberAwarenessSystem":"","packageName":"kernel","privilegesRequiredNVD":"","privilegesRequiredOE":"","scopeNVD":"","scopeOE":"","status":"Unaffected","summary":"An issue was discovered in the Linux kernel through 5.16-rc6. _rtw_init_xmit_priv in drivers/staging/r8188eu/core/rtw_xmit.c lacks check of the return value of rtw_alloc_hwxmits() and will cause the null pointer dereference.","type":"","userInteractionNVD":"","userInteractionOE":"","updateTime":"2023-03-01 11:01:28","createTime":"2023-03-01 11:01:28","securityNoticeNo":"","parserBean":null,"cvrf":null,"packageList":null}],"applicationCompList":[],"hardwareCompList":[],"driverCompList":[]},"success":true}
"""
