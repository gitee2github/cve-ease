#!/bin/bash

set -e

VERSION=0.0.2
RELEASE=1
WORKDIR=`pwd`
OUTPUTDIR=${WORKDIR}/release
SRCDIR=${WORKDIR}/../cve-ease/
VENDORDIR=${SRCDIR}/vendor

[ ! -d ${OUTPUTDIR} ] && mkdir -p ${OUTPUTDIR}

if [ ! -d ${SRCDIR} ];then
	echo "fatal error : source dir cve-ease not found!"
	exit 1
else
	echo " find src dir cve-ease ok"
fi

if [ ! -f ${WORKDIR}/cve-ease.spec ];then
	echo "fatal error : cve-ease.spec not found!"
	exit 1
else
	echo " find cve-ease.spec ok"
fi

RPMBUILD_DIR=`mktemp -d /tmp/rpmbuild-XXXX`
echo " build dir : ${RPMBUILD_DIR}"

mkdir ${RPMBUILD_DIR}/{BUILDS,SPECS,SOURCES,RPMS,SRPMS,BUILDROOT}
cd ${WORKDIR}
tar --transform "s/^./cve-ease-${VERSION}/" -zcf ${RPMBUILD_DIR}/SOURCES/cve-ease-${VERSION}.tar.gz -C ../cve-ease .
echo " generate cve-ease.tar.gz ok"
#ls -alh ${RPMBUILD_DIR}/SOURCES/cve-ease-${VERSION}.tar.gz
#tar -tf ${RPMBUILD_DIR}/SOURCES/cve-ease-${VERSION}.tar.gz

cd ${WORKDIR}
cp cve-ease.spec ${RPMBUILD_DIR}/SPECS/
sed -i "s/VERSION/${VERSION}/g" ${RPMBUILD_DIR}/SPECS/cve-ease.spec
sed -i "s/RELEASE/${RELEASE}/g" ${RPMBUILD_DIR}/SPECS/cve-ease.spec
echo " generate cve-ease.spec ok"

cd ${RPMBUILD_DIR}
rpmbuild  --define "_topdir  ${RPMBUILD_DIR}" -ba ${RPMBUILD_DIR}/SPECS/cve-ease.spec
if [ $? -ne 0 ];then
	echo " fatal error : rpm build failed!"
	exit 1
fi
echo " rpmbuild ok"

find ${RPMBUILD_DIR}/RPMS -name "*.rpm" |xargs -i mv {} ${OUTPUTDIR}/
find ${RPMBUILD_DIR}/SRPMS -name "*.rpm" |xargs -i mv {} ${OUTPUTDIR}/
md5sum ${OUTPUTDIR}/*
echo " copy rpms ok"

rpm -qpl ${OUTPUTDIR}/*.rpm
rm -rf ${RPMBUILD_DIR}
echo " clean ok"

echo " All done!"
